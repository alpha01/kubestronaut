name: Container & Kubernetes Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # https://github.com/controlplaneio/kubesec/blob/master/.github/workflows/security_analysis.yml
  trivy:
    name: Trivy
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build an image from Dockerfile
      run: |
        docker build . -t kubesec:${{ github.sha }}

    - name: Run Trivy
      uses: aquasecurity/trivy-action@0.32.0
      with:
        image-ref: kubesec:${{ github.sha }}
        format: template
        template: "@/contrib/sarif.tpl"
        output: trivy-results.sarif

    - name: Upload Trivy results to the Security tab
      # can't submit scan results on forks
      if: github.repository_owner == 'controlplaneio'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-results.sarif

  security:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # -----------------------------
    # Docker Build
    # -----------------------------
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Build NGINX image
      run: |
        docker build -t demo-nginx:${{ github.sha }} .

    # -----------------------------
    # Docker Scout (SBOM + CVEs)
    # -----------------------------
    # - name: Docker Scout - Quickview
    #   uses: docker/scout-action@v1
    #   with:
    #     command: quickview
    #     image: demo-nginx:${{ github.sha }}

    # - name: Docker Scout - CVE Scan
    #   uses: docker/scout-action@v1
    #   with:
    #     command: cves
    #     image: demo-nginx:${{ github.sha }}
    #     severity: critical,high
    #     exit-code: true

    # - name: Docker Scout - SBOM
    #   uses: docker/scout-action@v1
    #   with:
    #     command: sbom
    #     image: demo-nginx:${{ github.sha }}
    #     format: cyclonedx
    #     output: sbom.json

    # -----------------------------
    # kubesec scan (manifests)
    # -----------------------------
    - name: Install kubesec
      run: |
        curl -s https://kubesec.io/install.sh | bash
        sudo mv kubesec /usr/local/bin/

    - name: kubesec scan Kubernetes manifests
      run: |
        kubesec scan k8s/secured.yaml| tee kubesec-results.json

    - name: Fail if kubesec score is low
      run: |
        SCORE=$(jq '.[0].score' kubesec-results.json)
        echo "Kubesec score: $SCORE"
        if [ "$SCORE" -lt 7 ]; then
          echo "‚ùå kubesec score too low"
          exit 1
        fi

    # -----------------------------
    # kubelint (manifests)
    # -----------------------------
    - name: Scan manifests
      id: kube-lint-scan
      uses: stackrox/kube-linter-action@v1
      with:
        directory: k8s
